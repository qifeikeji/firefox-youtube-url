name: Build & Release (Firefox XPI)

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      note:
        description: "手动运行只会构建并上传 Actions Artifact；要发布到 Release 请推送 v*.*.* tag"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    env:
      AMO_JWT_ISSUER: ${{ secrets.AMO_JWT_ISSUER }}
      AMO_JWT_SECRET: ${{ secrets.AMO_JWT_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Build unsigned XPI (zip)
        run: |
          rm -rf dist
          mkdir -p dist
          web-ext build \
            --source-dir . \
            --artifacts-dir dist \
            --overwrite-dest \
            --ignore-files \
              .git/** \
              .github/** \
              dist/** \
              node_modules/** \
              terminals/** \
              README.md

          # web-ext 默认产物是 .zip；为了“Firefox 插件包”的直观性，同时提供 .xpi 副本
          ZIP="$(ls -1 dist/*.zip | head -n 1)"
          cp "$ZIP" "${ZIP%.zip}.xpi"

      - name: (Optional) Sign with AMO (unlisted)
        run: |
          # 需要 manifest.json 里配置 browser_specific_settings.gecko.id
          if [ -n "${AMO_JWT_ISSUER:-}" ] && [ -n "${AMO_JWT_SECRET:-}" ]; then
            web-ext sign \
              --source-dir . \
              --artifacts-dir dist \
              --channel unlisted \
              --api-key "$AMO_JWT_ISSUER" \
              --api-secret "$AMO_JWT_SECRET"
          else
            echo "AMO_JWT_ISSUER/AMO_JWT_SECRET 未配置，跳过签名步骤。"
          fi

      - name: Upload build artifacts (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: firefox-xpi
          path: dist/*

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*
          generate_release_notes: true


